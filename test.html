<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í™˜ìœ¨ ì‹œê°í™”</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #fff;
            color: #333;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #ccc;
        }
        header nav {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        .search-icon {
            font-size: 18px;
            cursor: pointer;
        }
        .graph-section {
            padding: 20px;
        }
        .tableauPlaceholder {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .filter-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        .filter-bar input, .filter-bar select {
            padding: 4px;
        }
        .country-list {
            padding: 0 20px;
        }
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .country-list table {
            width: 100%;
            border-collapse: collapse; /* ì…€ ê²½ê³„ì„  ë³‘í•© */
            margin-top: 15px;
        }

        .country-list th,
        .country-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: middle; /* ì„¸ë¡œ ì •ë ¬ ì¤‘ì•™ */
        }

        .country-list th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .country-list tr:nth-child(even) { /* ì§ìˆ˜ í–‰ ë°°ê²½ìƒ‰ */
            background-color: #f9f9f9;
        }

        .country-list tr:hover { /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ë°°ê²½ìƒ‰ */
            background-color: #e9e9e9;
        }

        .country-list td img { /* êµ­ê¸° ì´ë¯¸ì§€ í¬ê¸° ë° ì •ë ¬ */
            width: 32px;
            height: 20px;
            object-fit: cover;
            vertical-align: middle;
        }
        /* í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .pagination {
            text-align: center;
            margin: 20px 0;
        }
        .pagination span {
            display: inline-block;
            width: 25px; /* í˜ì´ì§€ ë²ˆí˜¸ê°€ ë“¤ì–´ê°ˆ ê³µê°„ */
            height: 25px;
            line-height: 25px; /* í…ìŠ¤íŠ¸ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            margin: 0 4px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }
        .pagination span:hover {
            background-color: #ddd;
        }
        .pagination span.active { /* í˜„ì¬ í™œì„±í™”ëœ í˜ì´ì§€ ë²ˆí˜¸ ìŠ¤íƒ€ì¼ */
            background-color: #007bff; /* íŒŒë€ìƒ‰ */
            color: white;
        }
        footer {
            text-align: center;
            padding: 30px 0;
            color: #ccc;
        }
    </style>
</head>
<body>
    <header>
        <div>ë¡œê³  ê¸€ì</div>
        <nav>
            <span>ì„¸ë¶€ 1</span>
            <span>ì„¸ë¶€ 2</span>
            <span>ì„¸ë¶€ 3</span>
            <span>ì„¸ë¶€ 4</span>
        </nav>
        <div class="search-icon">ğŸ”</div>
    </header>

    <section class="graph-section">
        <div class='tableauPlaceholder' id='viz1751518658560'>
            <noscript>
                <a href='#'><img alt='ì‹œíŠ¸ 1' src='https://public.tableau.com/static/images/_1/_17515184080120/1/1_rss.png' /></a>
            </noscript>
            <object class='tableauViz'>
                <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />
                <param name='embed_code_version' value='3' />
                <param name='site_root' value='' />
                <param name='name' value='_17515184080120/1' />
                <param name='tabs' value='no' />
                <param name='toolbar' value='yes' />
                <param name='static_image' value='https://public.tableau.com/static/images/_1/_17515184080120/1/1.png' />
                <param name='language' value='ko-KR' />
            </object>
        </div>
    </section>

    <div class="filter-bar">
        <input type="text" placeholder="ê²€ìƒ‰" />
        <select>
            <option>ì´ë¦„ìˆœ</option>
            <option>ìµœì‹ ìˆœ</option>
        </select>
    </div>

    <div class="country-list">
        <table>
            <thead>
                <tr>
                    <th>êµ­ê¸°</th>
                    <th>êµ­ê°€ëª…</th>
                    <th>í†µí™”</th>
                    <th>í™˜ìœ¨ (ì›)</th>
                    <th>ì „ì¼ëŒ€ë¹„</th>
                </tr>
            </thead>
            <tbody id="exchangeRateTableBody">
            </tbody>
        </table>
    </div>

    <div class="pagination" id="paginationControls">
    </div>

    <footer>footer</footer>

    <script type='text/javascript'>
        const vizElement = document.querySelector('.tableauViz');
        vizElement.style.width = '100%';
        vizElement.style.height = '500px';
        const script = document.createElement('script');
        script.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';
        document.body.appendChild(script);
    </script>

<script>
    const BACKEND_API = 'http://localhost:8080/api/exchange';
    const exchangeRateTableBody = document.getElementById('exchangeRateTableBody');
    const paginationControls = document.getElementById('paginationControls');

    let allExchangeData = [];
    const pageSize = 15;
    let currentPage = 1;

    function getLatestWeekday() {
        const today = new Date();
        const day = today.getDay();
        let daysToSubtract = 0;

        if (day === 0) { // ì¼ìš”ì¼ì´ë©´ 2ì¼ ì „ (ê¸ˆìš”ì¼)
            daysToSubtract = 2;
        } else if (day === 6) { // í† ìš”ì¼ì´ë©´ 1ì¼ ì „ (ê¸ˆìš”ì¼)
            daysToSubtract = 1;
        }
        
        today.setDate(today.getDate() - daysToSubtract);

        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const date = String(today.getDate()).padStart(2, '0');
        return `${year}${month}${date}`;
    }

    function renderTable(pageNumber) {
        exchangeRateTableBody.innerHTML = '';

        const startIndex = (pageNumber - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const itemsToDisplay = allExchangeData.slice(startIndex, endIndex);

        if (itemsToDisplay.length === 0) {
            exchangeRateTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        itemsToDisplay.forEach(item => {
            const curCode = item.currencyCode || '-';
            const curName = item.currencyName || '-';
            const baseRate = item.baseRate !== undefined ? item.baseRate : '-'; 
            const changeRate = item.changeRate !== undefined ? item.changeRate : '-'; 
            const flagUrl = item.flagUrl || ''; 
            const countryName = item.countryName || '-'; 

            // 'ì•Œ ìˆ˜ ì—†ìŒ' í•­ëª©ì„ ìƒëµí•˜ëŠ” ë¡œì§ì„ ë‹¤ì‹œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
            if (countryName === 'ì•Œ ìˆ˜ ì—†ìŒ' || countryName === '-') {
                console.log(`êµ­ê°€ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ '${curName} (${curCode})' í•­ëª©ì„ ìƒëµí•©ë‹ˆë‹¤.`);
                return; // ì´ í•­ëª©ì€ ê±´ë„ˆë›°ê³  ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
            }

            const html = `
                <tr>
                    <td><img src="${flagUrl}" alt="${countryName} êµ­ê¸°" /></td>
                    <td>${countryName}</td>
                    <td>${curName} (${curCode})</td>
                    <td>${typeof baseRate === 'number' ? baseRate.toLocaleString() : baseRate}</td>
                    <td>${typeof changeRate === 'number' ? changeRate.toLocaleString() : changeRate}</td>
                </tr>
            `;
            exchangeRateTableBody.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderPagination() {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(allExchangeData.length / pageSize);

        if (totalPages <= 1) {
            return;
        }

        for (let i = 1; i <= totalPages; i++) {
            const pageSpan = document.createElement('span');
            pageSpan.textContent = i;
            pageSpan.classList.add('page-number');
            if (i === currentPage) {
                pageSpan.classList.add('active');
            }
            pageSpan.addEventListener('click', () => {
                goToPage(i);
            });
            paginationControls.appendChild(pageSpan);
        }
    }

    function goToPage(pageNumber) {
        if (pageNumber < 1 || pageNumber > Math.ceil(allExchangeData.length / pageSize)) {
            return;
        }
        currentPage = pageNumber;
        renderTable(currentPage);
        renderPagination();
    }

    async function loadData() {
        try {
            const searchDate = getLatestWeekday();
            console.log('ë°±ì—”ë“œì— ìš”ì²­í•  ê²€ìƒ‰ ë‚ ì§œ:', searchDate);

            const response = await fetch(`${BACKEND_API}?searchDate=${searchDate}`).catch(error => {
                console.error('ë°±ì—”ë“œ API í˜¸ì¶œ ì˜¤ë¥˜ (fetch):', error);
                throw new Error('í™˜ìœ¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('ë°±ì—”ë“œ API ì‹¤íŒ¨ (response not ok):', response.status, errorText);
                throw new Error(`ë°±ì—”ë“œ API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ì˜¤ë¥˜: ${errorText.substring(0, 100)}...`);
            }

            // rawResponseText ë””ë²„ê¹… ì½”ë“œë¥¼ ì œê±°í•˜ê³ , response.json()ì„ ë°”ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            allExchangeData = await response.json(); 

            console.log('ë°±ì—”ë“œì—ì„œ ë°›ì€ ëª¨ë“  í™˜ìœ¨ ë°ì´í„° (ì¡°í•© ì™„ë£Œ):', allExchangeData);

            if (!Array.isArray(allExchangeData)) {
                console.warn('í™˜ìœ¨ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:', allExchangeData);
                throw new Error('í™˜ìœ¨ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }

            renderTable(currentPage);
            renderPagination();

        } catch (error) {
            console.error('ë°ì´í„° ë¡œë”© ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ:', error.message, error);
            exchangeRateTableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center; padding: 20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</td></tr>`;
            paginationControls.innerHTML = ''; 
        }
    }

    loadData();
</script>

</body>
</html>