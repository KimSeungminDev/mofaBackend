<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>환율 시각화</title>
    <style>
        /* 기존 스타일 유지 */
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #fff;
            color: #333;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #ccc;
        }
        header nav {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        .search-icon {
            font-size: 18px;
            cursor: pointer;
        }
        .graph-section {
            padding: 20px;
        }
        .tableauPlaceholder {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        .filter-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }
        .filter-bar input, .filter-bar select {
            padding: 4px;
        }
        .country-list {
            padding: 0 20px;
        }
        /* 테이블 스타일 */
        .country-list table {
            width: 100%;
            border-collapse: collapse; /* 셀 경계선 병합 */
            margin-top: 15px;
        }

        .country-list th,
        .country-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: middle; /* 세로 정렬 중앙 */
        }

        .country-list th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .country-list tr:nth-child(even) { /* 짝수 행 배경색 */
            background-color: #f9f9f9;
        }

        .country-list tr:hover { /* 마우스 오버 시 배경색 */
            background-color: #e9e9e9;
        }

        .country-list td img { /* 국기 이미지 크기 및 정렬 */
            width: 32px;
            height: 20px;
            object-fit: cover;
            vertical-align: middle;
        }
        /* 페이지네이션 컨트롤 스타일 */
        .pagination {
            text-align: center;
            margin: 20px 0;
        }
        .pagination span {
            display: inline-block;
            width: 25px; /* 페이지 번호가 들어갈 공간 */
            height: 25px;
            line-height: 25px; /* 텍스트 세로 중앙 정렬 */
            margin: 0 4px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }
        .pagination span:hover {
            background-color: #ddd;
        }
        .pagination span.active { /* 현재 활성화된 페이지 번호 스타일 */
            background-color: #007bff; /* 파란색 */
            color: white;
        }
        footer {
            text-align: center;
            padding: 30px 0;
            color: #ccc;
        }
    </style>
</head>
<body>
    <header>
        <div>로고 글자</div>
        <nav>
            <span>세부 1</span>
            <span>세부 2</span>
            <span>세부 3</span>
            <span>세부 4</span>
        </nav>
        <div class="search-icon">🔍</div>
    </header>

    <section class="graph-section">
        <div class='tableauPlaceholder' id='viz1751518658560'>
            <noscript>
                <a href='#'><img alt='시트 1' src='https://public.tableau.com/static/images/_1/_17515184080120/1/1_rss.png' /></a>
            </noscript>
            <object class='tableauViz'>
                <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' />
                <param name='embed_code_version' value='3' />
                <param name='site_root' value='' />
                <param name='name' value='_17515184080120/1' />
                <param name='tabs' value='no' />
                <param name='toolbar' value='yes' />
                <param name='static_image' value='https://public.tableau.com/static/images/_1/_17515184080120/1/1.png' />
                <param name='language' value='ko-KR' />
            </object>
        </div>
    </section>

    <div class="filter-bar">
        <input type="text" placeholder="검색" />
        <select>
            <option>이름순</option>
            <option>최신순</option>
        </select>
    </div>

    <div class="country-list">
        <table>
            <thead>
                <tr>
                    <th>국기</th>
                    <th>국가명</th>
                    <th>통화</th>
                    <th>환율 (원)</th>
                    <th>전일대비</th>
                </tr>
            </thead>
            <tbody id="exchangeRateTableBody">
            </tbody>
        </table>
    </div>

    <div class="pagination" id="paginationControls">
    </div>

    <footer>footer</footer>

    <script type='text/javascript'>
        const vizElement = document.querySelector('.tableauViz');
        vizElement.style.width = '100%';
        vizElement.style.height = '500px';
        const script = document.createElement('script');
        script.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';
        document.body.appendChild(script);
    </script>

<script>
    const BACKEND_API = 'http://localhost:8080/api/exchange';
    const exchangeRateTableBody = document.getElementById('exchangeRateTableBody');
    const paginationControls = document.getElementById('paginationControls');

    let allExchangeData = [];
    const pageSize = 15;
    let currentPage = 1;

    function getLatestWeekday() {
        const today = new Date();
        const day = today.getDay();
        let daysToSubtract = 0;

        if (day === 0) { // 일요일이면 2일 전 (금요일)
            daysToSubtract = 2;
        } else if (day === 6) { // 토요일이면 1일 전 (금요일)
            daysToSubtract = 1;
        }
        
        today.setDate(today.getDate() - daysToSubtract);

        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const date = String(today.getDate()).padStart(2, '0');
        return `${year}${month}${date}`;
    }

    function renderTable(pageNumber) {
        exchangeRateTableBody.innerHTML = '';

        const startIndex = (pageNumber - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const itemsToDisplay = allExchangeData.slice(startIndex, endIndex);

        if (itemsToDisplay.length === 0) {
            exchangeRateTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">표시할 데이터가 없습니다.</td></tr>`;
            return;
        }

        itemsToDisplay.forEach(item => {
            const curCode = item.currencyCode || '-';
            const curName = item.currencyName || '-';
            const baseRate = item.baseRate !== undefined ? item.baseRate : '-'; 
            const changeRate = item.changeRate !== undefined ? item.changeRate : '-'; 
            const flagUrl = item.flagUrl || ''; 
            const countryName = item.countryName || '-'; 

            // '알 수 없음' 항목을 생략하는 로직을 다시 추가했습니다.
            if (countryName === '알 수 없음' || countryName === '-') {
                console.log(`국가명을 찾을 수 없어 '${curName} (${curCode})' 항목을 생략합니다.`);
                return; // 이 항목은 건너뛰고 다음 항목으로 넘어갑니다.
            }

            const html = `
                <tr>
                    <td><img src="${flagUrl}" alt="${countryName} 국기" /></td>
                    <td>${countryName}</td>
                    <td>${curName} (${curCode})</td>
                    <td>${typeof baseRate === 'number' ? baseRate.toLocaleString() : baseRate}</td>
                    <td>${typeof changeRate === 'number' ? changeRate.toLocaleString() : changeRate}</td>
                </tr>
            `;
            exchangeRateTableBody.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderPagination() {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(allExchangeData.length / pageSize);

        if (totalPages <= 1) {
            return;
        }

        for (let i = 1; i <= totalPages; i++) {
            const pageSpan = document.createElement('span');
            pageSpan.textContent = i;
            pageSpan.classList.add('page-number');
            if (i === currentPage) {
                pageSpan.classList.add('active');
            }
            pageSpan.addEventListener('click', () => {
                goToPage(i);
            });
            paginationControls.appendChild(pageSpan);
        }
    }

    function goToPage(pageNumber) {
        if (pageNumber < 1 || pageNumber > Math.ceil(allExchangeData.length / pageSize)) {
            return;
        }
        currentPage = pageNumber;
        renderTable(currentPage);
        renderPagination();
    }

    async function loadData() {
        try {
            const searchDate = getLatestWeekday();
            console.log('백엔드에 요청할 검색 날짜:', searchDate);

            const response = await fetch(`${BACKEND_API}?searchDate=${searchDate}`).catch(error => {
                console.error('백엔드 API 호출 오류 (fetch):', error);
                throw new Error('환율 정보를 가져오지 못했습니다. 백엔드 서버가 실행 중인지 확인하세요.');
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('백엔드 API 실패 (response not ok):', response.status, errorText);
                throw new Error(`백엔드 API 호출 실패: ${response.status} 오류: ${errorText.substring(0, 100)}...`);
            }

            // rawResponseText 디버깅 코드를 제거하고, response.json()을 바로 사용합니다.
            allExchangeData = await response.json(); 

            console.log('백엔드에서 받은 모든 환율 데이터 (조합 완료):', allExchangeData);

            if (!Array.isArray(allExchangeData)) {
                console.warn('환율 데이터가 배열이 아닙니다:', allExchangeData);
                throw new Error('환율 데이터 형식이 올바르지 않습니다.');
            }

            renderTable(currentPage);
            renderPagination();

        } catch (error) {
            console.error('데이터 로딩 중 치명적인 오류 발생:', error.message, error);
            exchangeRateTableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center; padding: 20px;">데이터를 불러오는 데 실패했습니다: ${error.message}</td></tr>`;
            paginationControls.innerHTML = ''; 
        }
    }

    loadData();
</script>

</body>
</html>